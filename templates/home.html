<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YT-DLP-music panel</title>
    <style>
        textarea {
            width: 100%;
            height: 700px;
        }        
        table { 
            width: 100%;
            table-layout: fixed;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>

</head>
<body>
    <h1>yt-dlp-music panel</h1>

    <h2>Enter URLs to download</h2>
    <form id="urlForm">
        <textarea name="urls" rows="2" cols="20" placeholder="Enter URLs comma-separated..."></textarea><br>
        <input type="button" value="Submit URLs for processing" onclick="submitForm()">
    </form>
    <br>
    <button onclick="location.reload()" id="refreshButton">Refresh</button>

    <h2>Job Statuses</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>URL</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="jobStatuses">
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>
    
    <table>
        <tr>
            <th></th>
            <th>In</th>
            <th>Ongoing</th>
            <th>Finished</th>
        </tr>
        <tr>
            <th>Audio</th>
            <td><textarea id="audioIn" readonly>{{ audio_in|join('\n') }}</textarea></td>
            <td><textarea id="audioOngoing" readonly>{{ audio_ongoing|join('\n') }}</textarea></td>
            <td><textarea id="audioFinished" readonly>{{ audio_finished|join('\n') }}</textarea></td>
        </tr>
        <tr>
            <th>Video</th>
            <td><textarea id="videoIn" readonly>{{ video_in|join('\n') }}</textarea></td>
            <td><textarea id="videoOngoing" readonly>{{ video_ongoing|join('\n') }}</textarea></td>
            <td><textarea id="videoFinished" readonly>{{ video_finished|join('\n') }}</textarea></td>
        </tr>
    </table>

    <script>
        var socket = io.connect(window.location.origin);
        socket.on('atom_update_status', function(data) {
            console.log(data);
            // Now, use the data to update your frontend.
            // For example, if you have a table or list where you display the atoms:
            updateAtomStatus(data);
        });

        function submitForm() {
            var formData = $("#urlForm").serialize();
        
            $.post("/", formData, function(data) {
                console.log("Server response:", data);
            });
        }

        function updateAtomStatus(data) {
            var tableBody = document.getElementById('jobStatuses');
            var row = document.getElementById(data.id);
            
            if (row) {
                // Update existing row
                row.querySelector('.statusColumn').innerText = data.status;
            } else {
                // Create a new row and append to the table
                var newRow = tableBody.insertRow();
                newRow.id = data.id;
        
                var idCell = newRow.insertCell(0);
                var urlCell = newRow.insertCell(1);
                var statusCell = newRow.insertCell(2);
                
                idCell.innerText = data.id;
                urlCell.innerText = data.url;
                statusCell.innerText = data.status;
                statusCell.className = 'statusColumn';
            }
        }
        
        
        $(document).ready(function() {
            $('#refreshButton').click(function() {
                $.get('/queue', function(data) {
                    $('#audioIn').text(data.audio_in.join('\n'));
                    $('#audioOngoing').text(data.audio_ongoing.join('\n'));
                    $('#audioFinished').text(data.audio_finished.join('\n'));
                    $('#videoIn').text(data.video_in.join('\n'));
                    $('#videoOngoing').text(data.video_ongoing.join('\n'));
                    $('#videoFinished').text(data.video_finished.join('\n'));
                });
            });
            socket.emit('request_initial_data');
        });
    </script>
</body>
</html>
